# Automatic Server Bringup (ASB) related global variables
ASB_DB: "servers"
ASB_PROP_DB: "server_property"
ASB_CMDS_DB: "server_cmd"
ASB_ROOT_MNTPT: "/tmp/root"
STAGES_PATH: "{{playbook_dir}}/stages/"


# ASB Statuses
# ------------
ASB_STATUS_FRESH: "fresh"
ASB_STATUS_REPAIR_START: "repair_start"
ASB_STATUS_REPAIR_RUNNING: "repair_running"
ASB_STATUS_REPAIR_VERIFY: "repair_verify"
ASB_STATUS_REIMG_HEALTH: "reimage_healthcheck"
ASB_STATUS_REIMG_WIPE: "reimage_wipe"
ASB_STATUS_REIMG_VERIFY: "reimage_verify"
ASB_STATUS_CORE: "core"
ASB_STATUS_CORE_VERIFY: "core_verify"
ASB_STATUS_RESYNC_RUNNING: "resync_running"
ASB_STATUS_CONF: "config"
ASB_STATUS_AUTH: "auth"
ASB_STATUS_CLEANUP: "cleanup"
ASB_STATUS_INSTALLED: "installed"
ASB_STATUS_HELP: "HELP_ME"

# Reimage
# -------
# Constants used in the reimage steps.
## SMART attributes that are critical, ie. predict disk failure.
THRESHOLD_SMART_RSC: 100  # Reallocated_Sector_Ct: count of bad sectors that had
                          # been found and remapped. Our disks have some 1000's
                          # spare sectors for these remapping. However, after using
                          # a few hundreds of spare sectors, the machine most likely
                          # won't be in usable condition as the disk will usually
                          # drop out of the RAID array when encountering another bad
                          # sector, and require a reboot to fix. (from twieland)
THRESHOLD_SMART_OU: 100   # Offline_Uncorrectable: count of uncorrectable errors
                          # when reading/writing a sector.
THRESHOLD_SMART_CPS: 30   # Current_Pending_Sector: count of unstable sectors that
                          # are waiting to be remapped due to uncorrectable read
                          # errors. The threshold is lower than that for RSC and OU
                          # because a non-zero CPS meant the disk is not operating
                          # at 100% due to less sectors for use than usual.
THRESHOLD_SMART_RU: 0     # Reported_Uncorrect: count of reads that cannot be
                          # corrected using hardware ECC.
                          # A non-zero value may indicate hardware problem.
## SMART attributes that are non-critical but may indicate disk problems.
THRESHOLD_SMART_RRER: 100 # Raw_Read_Error_Rate: hardware read error.
                          # The threshold is more a rule-of-thumb that any disk with
                          # RRER over it probably has some hardware problems.
                          # (from tnewsome and twieland)
THRESHOLD_SMART_UDMA: 100 # UDMA_CRC_Error_Count: errors in data transfer via the
                          # interface cable.
                          # High value may indicate connection problem in SATA cable.
THRESHOLD_SMART_MZER: 100 # Multi_Zone_Error_Rate: error when writing a sector.
                          # High value indicate disk is in bad mechanical condition.
# Constants used by MySQL queries when a retry is triggered.
# They are used in queries related to datacenter.server_property table.
ASB_REIMG_RETRY_COUNT: "retryCount"
ASB_REIMG_RETRY_STAGE: "retryStage"
ASB_REIMG_RETRY_INITIAL_COUNT: 3


# MySQL Query
# -----------
ASB_DB_QUERY: "mysql -N -u arastra -e \"SELECT status, role FROM {{ASB_DB}} WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"
ASB_PROP_QUERY: "mysql -N -u arastra -e \"SELECT propertyValue from {{ASB_PROP_DB}} where serverName=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\" AND propertyName=\\\"numDisks\\\"\" -h mysql datacenter"
ASB_CMDS_QUERY: "mysql -N -u arastra -e \"SELECT diskConfCmd, instSWCmd FROM {{ASB_CMDS_DB}} WHERE role=\\\"{{ROLE_NAME}}\\\" and numDisks={{DISK_NUM}}\" -h mysql datacenter"

ASB_DB_REIMG_RETRY_CHECK_COUNT: "mysql -N -u arastra -e \"SELECT propertyValue FROM {{ASB_PROP_DB}} WHERE serverName='{{ansible_hostname}}' AND domain='{{ansible_domain}}' AND propertyName='{{ASB_REIMG_RETRY_COUNT}}'\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_CHECK_STAGE: "mysql -N -u arastra -e \"SELECT propertyValue FROM {{ASB_PROP_DB}} WHERE serverName='{{ansible_hostname}}' AND domain='{{ansible_domain}}' AND propertyName='{{ASB_REIMG_RETRY_STAGE}}'\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_CREATE: "mysql -N -u arastra -e \"INSERT INTO {{ASB_PROP_DB}} ( serverName, domain, propertyName, propertyValue ) VALUES( '{{ansible_hostname}}', '{{ansible_domain}}', '{{ASB_REIMG_RETRY_COUNT}}', {{ASB_REIMG_RETRY_INITIAL_COUNT}} )\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_DECREMENT: "mysql -N -u arastra -e \"UPDATE {{ASB_PROP_DB}} SET propertyValue = propertyValue - 1 WHERE serverName='{{ansible_hostname}}' AND domain='{{ansible_domain}}' AND propertyName='{{ASB_REIMG_RETRY_COUNT}}'\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_DELETE: "mysql -N -u arastra -e \"DELETE FROM {{ASB_PROP_DB}} WHERE serverName='{{ansible_hostname}}' and domain='{{ansible_domain}}' and ( propertyName='{{ASB_REIMG_RETRY_COUNT}}' or propertyName='{{ASB_REIMG_RETRY_STAGE}}' )\" -h mysql datacenter"

ASB_DB_UPDATE_TEMPLATE: "mysql -u arastra -e \"UPDATE {{ASB_DB}} SET status=\\\"%s\\\" WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"
ASB_DB_UPDATE_REPAIR_START: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REPAIR_START ) }}"
ASB_DB_UPDATE_REPAIR_RUNNING: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REPAIR_RUNNING ) }}"
ASB_DB_UPDATE_REPAIR_VERIFY: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REPAIR_VERIFY ) }}"
ASB_DB_UPDATE_REIMG_HEALTH: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REIMG_HEALTH ) }}"
ASB_DB_UPDATE_REIMG_WIPE: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REIMG_WIPE ) }}"
ASB_DB_UPDATE_REIMG_VERIFY: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REIMG_VERIFY ) }}"
ASB_DB_UPDATE_CORE: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_CORE ) }}"
ASB_DB_UPDATE_CORE_VERIFY: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_CORE_VERIFY ) }}"
ASB_DB_UPDATE_RESYNC_RUNNING: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_RESYNC_RUNNING ) }}"
ASB_DB_UPDATE_CONF: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_CONF ) }}"
ASB_DB_UPDATE_AUTH: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_AUTH ) }}"
ASB_DB_UPDATE_CLEANUP: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_CLEANUP ) }}"
ASB_DB_UPDATE_INSTALLED: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_INSTALLED ) }}"
ASB_DB_UPDATE_HELP: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_HELP ) }}"

ASB_DB_SET_DISABLEMONITORING: "mysql -u arastra -e \"UPDATE {{ASB_DB}} SET disableMonitoring=1 WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"
ASB_DB_RESET_DISABLEMONITORING: "mysql -u arastra -e \"UPDATE {{ASB_DB}} SET disableMonitoring=0 WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"

ASB_STESTS_QUERY: "mysql -u arastra -e \"select project from job where type=\\\"stest\\\" and host=\\\"{{ansible_fqdn}}\\\" and endTime is NULL and startTime >= DATE_SUB(NOW(),INTERVAL 1 DAY);\" -h mysql Arjob"
