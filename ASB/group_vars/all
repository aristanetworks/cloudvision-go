# Automatic Server Bringup (ASB) related global variables
#
# This is the amount of time we want the machine available for human intervention
# without having Ansible take over. 20mins in seconds == 1200.
ASB_MAX_UPTIME: 1200

ASB_TICKET_STALE: 3600

ASB_DB: "servers"
ASB_PROP_DB: "server_property"
ASB_CMDS_DB: "server_cmd"
ASB_ROOT_MNTPT: "/tmp/root"

STAGES_PATH: "{{playbook_dir}}/stages/"


# ASB Statuses
# ------------
ASB_STATUS_FRESH: "fresh"
ASB_STATUS_REIMG_STANDBY: "reimage_standby"
ASB_STATUS_REIMG_SANITY: "reimage_sanity"
ASB_STATUS_REIMG_WIPE: "reimage_wipe"
ASB_STATUS_REIMG_VERIFY: "reimage_verify"
ASB_STATUS_DISK: "disk"
ASB_STATUS_OS: "os"
ASB_STATUS_CONF: "config"
ASB_STATUS_VERIFY: "verify"
ASB_STATUS_AUTH: "auth"
ASB_STATUS_INSTALLED: "installed"
ASB_STATUS_HELP: "HELP_ME"

# Reimage
# -------
# Constants used in the reimage steps.
## SMART attributes that are critical, ie. predict disk failure.
THRESHOLD_SMART_RSC: 100  # Reallocated_Sector_Ct: count of bad sectors that had
                          # been found and remapped. Our disks have some 1000's
                          # spare sectors for these remapping. However, after using
                          # a few hundreds of spare sectors, the machine most likely
                          # won't be in usable condition as the disk will usually
                          # drop out of the RAID array when encountering another bad
                          # sector, and require a reboot to fix. (from twieland)
THRESHOLD_SMART_OU: 100   # Offline_Uncorrectable: count of uncorrectable errors
                          # when reading/writing a sector.
THRESHOLD_SMART_CPS: 30   # Current_Pending_Sector: count of unstable sectors that
                          # are waiting to be remapped due to uncorrectable read
                          # errors. The threshold is lower than that for RSC and OU
                          # because a non-zero CPS meant the disk is not operating
                          # at 100% due to less sectors for use than usual.
THRESHOLD_SMART_RU: 0     # Reported_Uncorrect: count of reads that cannot be
                          # corrected using hardware ECC.
                          # A non-zero value may indicate hardware problem.
## SMART attributes that are non-critical but may indicate disk problems.
THRESHOLD_SMART_RRER: 100 # Raw_Read_Error_Rate: hardware read error.
                          # The threshold is more a rule-of-thumb that any disk with
                          # RRER over it probably has some hardware problems.
                          # (from tnewsome and twieland)
THRESHOLD_SMART_UDMA: 100 # UDMA_CRC_Error_Count: errors in data transfer via the
                          # interface cable.
                          # High value may indicate connection problem in SATA cable.
THRESHOLD_SMART_MZER: 100 # Multi_Zone_Error_Rate: error when writing a sector.
                          # High value indicate disk is in bad mechanical condition.
# Constants used by MySQL queries when a retry is triggered.
# They are used in queries related to datacenter.server_property table.
ASB_REIMG_RETRY_PROP_NAME: "retryCount"
ASB_REIMG_RETRY_INITIAL_COUNT: 3


# MySQL Query
# -----------
ASB_DB_QUERY: "mysql -N -u arastra -e \"SELECT status, role FROM {{ASB_DB}} WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"
ASB_PROP_QUERY: "mysql -N -u arastra -e \"SELECT propertyValue from {{ASB_PROP_DB}} where serverName=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\" AND propertyName=\\\"numDisks\\\"\" -h mysql datacenter"
ASB_CMDS_QUERY: "mysql -N -u arastra -e \"SELECT diskConfCmd, instSWCmd FROM {{ASB_CMDS_DB}} WHERE role=\\\"{{ROLE_NAME}}\\\" and numDisks={{DISK_NUM}}\" -h mysql datacenter"

ASB_DB_REIMG_RETRY_CHECK: "mysql -N -u arastra -e \"SELECT propertyValue FROM {{ASB_PROP_DB}} WHERE serverName='{{ansible_hostname}}' AND domain='{{ansible_domain}}' AND propertyName='{{ASB_REIMG_RETRY_PROP_NAME}}'\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_CREATE: "mysql -N -u arastra -e \"INSERT INTO {{ASB_PROP_DB}} ( serverName, domain, propertyName, propertyValue ) VALUES( '{{ansible_hostname}}', '{{ansible_domain}}', '{{ASB_REIMG_RETRY_PROP_NAME}}', {{ASB_REIMG_RETRY_INITIAL_COUNT}} )\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_DECREMENT: "mysql -N -u arastra -e \"UPDATE {{ASB_PROP_DB}} SET propertyValue = propertyValue - 1 WHERE serverName='{{ansible_hostname}}' AND domain='{{ansible_domain}}' AND propertyName='{{ASB_REIMG_RETRY_PROP_NAME}}'\" -h mysql datacenter"
ASB_DB_REIMG_RETRY_DELETE: "mysql -N -u arastra -e \"DELETE FROM {{ASB_PROP_DB}} WHERE serverName='{{ansible_hostname}}' and domain='{{ansible_domain}}' and propertyName='{{ASB_REIMG_RETRY_PROP_NAME}}'\" -h mysql datacenter"

ASB_DB_UPDATE_TEMPLATE: "mysql -u arastra -e \"UPDATE {{ASB_DB}} SET status=\\\"%s\\\" WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"
ASB_DB_UPDATE_REIMG_SANITY: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REIMG_SANITY ) }}"
ASB_DB_UPDATE_REIMG_WIPE: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REIMG_WIPE ) }}"
ASB_DB_UPDATE_REIMG_VERIFY: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_REIMG_VERIFY ) }}"
ASB_DB_UPDATE_DISK: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_DISK ) }}"
ASB_DB_UPDATE_OS: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_OS ) }}"
ASB_DB_UPDATE_CONF: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_CONF ) }}"
ASB_DB_UPDATE_VERIFY: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_VERIFY ) }}"
ASB_DB_UPDATE_AUTH: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_AUTH ) }}"
ASB_DB_UPDATE_INSTALLED: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_INSTALLED ) }}"
ASB_DB_UPDATE_HELP: "{{ ASB_DB_UPDATE_TEMPLATE | regex_replace( '%s', ASB_STATUS_HELP ) }}"

ASB_DB_RESET_DISABLEMONITORING: "mysql -u arastra -e \"UPDATE {{ASB_DB}} SET disableMonitoring=0 WHERE name=\\\"{{ansible_hostname}}\\\" AND domain=\\\"{{ansible_domain}}\\\"\" -h mysql datacenter"

# Email Templates
ASB_MAIL_RECP: "twieland@arista.com,ren@arista.com" #TODO: this will permanently be sw-infra-support
ASB_MAIL_HDR: "[ASB] {{ansible_hostname}} is ready"
ASB_MAIL_BDY: "ASB has finished automatically bringing up {{ansible_hostname}}.\n\nPlease issue a ticket for this server and run AuthenticateArastra."
ASB_MAIL_COMPLETE: "echo \"{{ASB_MAIL_BDY}}\" | mail -s \"{{ASB_MAIL_HDR}}\" {{ASB_MAIL_RECP}}"


ASB_MAIL_REIMG_CFG_REPT: "/tmp/CURR_CONFIG"
ASB_MAIL_REIMG_SANITY_HDR_ERR: "[ASB] ERROR: {{ansible_hostname}} is being reimaged"
ASB_MAIL_REIMG_SANITY_BDY_ERR: "ASB attempted at reimaging {{ansible_hostname}} but this machine is currently unhealthy. Please view the attached configuration report and manually fix the machine to a state where it can be reimaged."
ASB_MAIL_REIMG_SANITY_HDR: "[ASB] {{ansible_hostname}} is being reimaged"
ASB_MAIL_REIMG_SANITY_BDY: "ASB is ready to reimage {{ansible_hostname}}. Please see the attached report to view current status of the machine."

ASB_MAIL_REIMG_SANITY: "echo \"{{ASB_MAIL_REIMG_SANITY_BDY}}\" | mail -s \"{{ASB_MAIL_REIMG_SANITY_HDR}}\" -a {{ASB_MAIL_REIMG_CFG_REPT}} {{ASB_MAIL_RECP}}"
ASB_MAIL_REIMG_SANITY_ERR: "echo \"{{ASB_MAIL_REIMG_SANITY_BDY_ERR}}\" | mail -s \"{{ASB_MAIL_REIMG_SANITY_HDR_ERR}}\" -a {{ASB_MAIL_REIMG_CFG_REPT}} {{ASB_MAIL_RECP}}"


ASB_MAIL_REIMG_WIPE_HDR_ERR: "[ASB] ERROR: {{ansible_hostname}} cannot be reimaged"
ASB_MAIL_REIMG_WIPE_BDY_ERR: "ASB encountered error while trying to wipe current partitions and disk configurations. Manual intervention is required."
ASB_MAIL_REIMG_WIPE_ERR: "echo \"{{ASB_MAIL_REIMG_WIPE_BDY_ERR}}\" | mail -s \"{{ASB_MAIL_REIMG_WIPE_HDR_ERR}}\" {{ASB_MAIL_RECP}}"
