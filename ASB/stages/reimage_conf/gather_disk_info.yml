---
# Gather the relevant disk info for use by reimage tasks.
- name: "Get the list of available disks on this machine."
  set_fact:
     disks: "{{ ansible_devices.keys() }}"

- name: "Get the model for each disk."
  set_fact:
     disk_models: "{{ disk_models | default( {} ) | combine( {item: ansible_devices[ item ][ 'model' ] } ) }}"
  with_items: "{{ disks }}"

- name: "Read /proc/mdstat for list of md devices."
  shell: "cat /proc/mdstat | awk '/^[md]/ {print $1}'"
  register: mdInfo

- name: "Get the list of md devices that are part of the RAID arrays."
  set_fact:
     mddevs: "{{ mdInfo.stdout_lines }}"
  when: mdInfo is defined

- name: "Get the list of partitions on the disks."
  set_fact:
     partitions: "{{ partitions | default( [] ) + item.value.partitions.keys() }}"
  with_dict: "{{ ansible_devices }}"
...
