---
# Gather the relevant disk info for use by reimage tasks.
- name: "Find SCSI disks from ansible devices"
  set_fact:
    disks: "{{ disks | default([])  + [ item ] }}"
  when: item | match("sd.*")
  with_items: "{{ ansible_devices.keys() }}"

- fail: msg="Could not find any disks."
  when: disks is not defined or disks | length == 0

- name: "Get the model for each disk."
  set_fact:
     disk_models: "{{ disk_models | default( {} ) | combine( {item: ansible_devices[ item ][ 'model' ] } ) }}"
  with_items: "{{ disks }}"

- name: "Read /proc/mdstat for list of md devices."
  shell: "cat /proc/mdstat | awk '/^[md]/ {print $1}'"
  register: mdInfo

- name: "Get the list of md devices that are part of the RAID arrays."
  set_fact:
     mddevs: "{{ mdInfo.stdout_lines }}"
  when: mdInfo is defined

- name: "Get the list of partitions on the disks."
  set_fact:
     partitions: "{{ partitions | default( [] ) + item.value.partitions.keys() }}"
  with_dict: "{{ ansible_devices }}"
...
