---
- name: "Run common configuration steps"
  include: "{{STAGES_PATH}}/config_conf/config_common.yml"

- name: "Delete unnecessary server build tags"
  shell: "Abuildd --deltags=\"fedora14 bs3xx\""

- name: "Add stest server build tags"
  shell: "Abuildd --addtags=\"fedora18 medium largemem bs2xx\""

- name: "Install docker"
  yum:
      name: docker
      state: installed

- name: "Customize open file limit"
  become: True
  copy:
    src: 92-Stest.conf
    dest: /etc/security/limits.d/92-Stest.conf

- name: "Customize Max process limit"
  become: True
  copy:
    src: 92-Stest-nproc.conf
    dest: /etc/security/limits.d/93-Stest-nproc.conf

# ----------------------------
# Customize inotify parameters
# ----------------------------

# Bump up this limit to make stests not hit BUG42769/BUG89834 and friends.
- name: "Set inotify max user instances"
  sysctl:
     name: fs.inotify.max_user_instances
     value: 32768
     state: present
     sysctl_file: "/etc/sysctl.d/Stest.conf"

# Bump up this to make stests not hit BUG136042
- name: "Set inotify max user watchers"
  sysctl:
     name: fs.inotify.max_user_watchers
     value: 524288
     state: present
     sysctl_file: "/etc/sysctl.d/Stest.conf"
     reload: yes

# ----------------------------

- name: "Add docker to rc.local"
  lineinfile:
     dest: /etc/rc.d/rc.local
     line: "systemctl start docker"

- name: "Install Stest package"
  yum:
      name: AroraConfig-stest
      state: installed

- name: "Enable Stests"
  shell: "{{STAGES_PATH}}/common_conf/changeCfg /etc/Arora.cfg Stest enabled True"

- name: "Update datacenter.servers with status configuration ready"
  command: "{{ASB_DB_UPDATE_AUTH}}"

- name: "Reboot"
  command: "reboot"
...
