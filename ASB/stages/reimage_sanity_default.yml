---
- name: "Gather info about disks on this machine"
  include: "{{STAGES_PATH}}/reimage_conf/gather_disk_info.yml"

- name: "Disable abuild"
  replace:
      dest: "/etc/Abuildd.conf"
      regexp: "enabled"
      replace: "enabled = never"
  ignore_errors: yes

- name: "Uninstall stest RPM if installed"
  yum:
      name: AroraConfig-stest.x86_64
      state: absent

# ----------------------------------------------------------------------------------
- block:
   - fail: msg="No disk drives detected, something is very wrong"
     when: disks is not defined

   - name: "Sanity check on each disk."
     include: "{{STAGES_PATH}}/reimage_conf/smart_check.yml disk={{ item }}"
     with_items: "{{ disks }}"
        
  rescue:
   - name: "Send SOS email about this machine"
     shell: "{{ASB_MAIL_REIMG_SANITY_ERR}}"

   - name: "There's nothing more that ASB can do..."
     command: "{{ASB_DB_UPDATE_HELP}}"

   - fail: msg="Machine is too unhealthy to be reimaged - aborting without making changes"
# ----------------------------------------------------------------------------------

## Require rewrite as status report is no longer generated, or, if not needed,
## the task should be deleted
#- name: "Send an email that this machine is being reimaged with report"
#  shell: "{{ASB_MAIL_REIMG_SANITY}}"

- name: "Update server status"
  command:  "{{ASB_DB_UPDATE_REIMG_WIPE}}"
...
