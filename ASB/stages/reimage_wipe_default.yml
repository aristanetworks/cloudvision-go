---
- name: "Gather info about disks on this machine"
  include: "{{STAGES_PATH}}/reimage_conf/gather_disk_info.yml"

# ----------------------------------------------------------------------------------
- block:
   - fail: msg="No disk drives detected, something is very wrong"
     when: disks is not defined

   - name: "Check if MD arrays exist."
     debug: msg="No MD arrays detected."
     when: mddevs is not defined

   - name: "Check if partitions on the disk drives exist."
     debug: msg="No partitions on the disk drives detected."
     when: partitions is not defined

   - name: "Disable page swaps."
     command: "swapoff -a"
     ignore_errors: true

   - name: "Unmount all MD arrays."
     shell: "umount /dev/{{ item }}"
     with_items: "{{ mddevs }}"
     ignore_errors: true
     when: mddevs is defined

   - name: "Stop all MD arrays."
     shell: "mdadm --stop /dev/{{ item }}"
     with_items: "{{ mddevs }}"
     ignore_errors: true
     when: mddevs is defined

   - name: "Zero out the superblock for every partition on each disk."
     command: "mdadm --zero-superblock --force /dev/{{ item }}"
     with_items: "{{ partitions }}"
     ignore_errors: true
     when: partitions is defined

   - name: "Zero out any potential superblocks sitting at the header of each disk."
     command: "mdadm --zero-superblock --force /dev/{{ item }}"
     with_items: "{{ disks }}"
     ignore_errors: true

   - name: "Remove each partition from the table."
     command: "parted -s /dev/{{ item | regex_replace( '^([a-z]+)([0-9]+)$', '\\1' ) }} rm {{ item | regex_replace( '^([a-z]+)([0-9]+)$', '\\2' ) }}"
     with_items: "{{ partitions }}"
     ignore_errors: true
     when: partitions is defined

  rescue:
   - name: "There's nothing more than ASB can do. Setting server status to 'HELP_ME'"
     command: "{{ASB_DB_UPDATE_HELP}}"

   - fail: msg="Automatic wipe of this machine was unsuccessful."
# ----------------------------------------------------------------------------------

- name: "Inform Kernel of the partition table changes."
  command: "partprobe"
  ignore_errors: true
  when: disks is defined

- name: "Turn off firewall to enable booting from PXE server successful"
  service:
     name: iptables
     state: stopped

- name: "Verify pxe server is reachable"
  command: "ping -c 5 pxe"

- name: "Update server status"
  command: "{{ASB_DB_UPDATE_REIMG_VERIFY}}"

- name: "Reboot with f18"
  shell: "pxe-kexec -n pxe <<< \"f18-arora-pxe-kexec\""
...
