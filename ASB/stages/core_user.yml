---
- block:
   - name: "Copy disk setup script to /root"
     copy:
         src: "{{STAGES_PATH}}/core_conf/SetupAroraDisk.build+user"
         dest: /root

   - name: "Partition and format disks"
     shell: "python /root/{{DISK_CMD}}"

   - name: "Install OS"
     shell: "{{SW_CMD}}"

  rescue:
   - name: "Reimage this machine"
     include: "{{STAGES_PATH}}/reimage_conf/retry.yml"

   - fail: msg="Errors while setting up disk and installing OS; Retrying by reimaging anew"

# We skip RAID resync for user servers because it takes too long over RAID 5 systems
- name: "Update datacenter.servers with status that disk setup has finished"
  command: "{{ASB_DB_UPDATE_CONF}}"

# Best effort to get server to reboot from disk. Would not work with older servers
# without ipmitool available.
- name: "Set boot devive to disk"
  command: "ipmitool -H {{ ansible_hostname }}-ipmi -U ADMIN -P ADMIN chassis bootdev disk options=persistent"
  ignore_errors: true

- name: "Reboot"
  command: reboot
...

