---
- name: "Disable monitoring while this machine is getting reimaged"
  command: "{{ASB_DB_SET_DISABLEMONITORING}}"

- name: "Gather info about disks on this machine"
  include: "{{STAGES_PATH}}/reimage_conf/gather_disk_info.yml"

- name: "Disable Stests"
  shell: "python {{STAGES_PATH}}/common_conf/changeCfg /etc/Arora.cfg Stest enabled False"

# According to ssingla@ stests should not run more than 8 hours
- name: "Check if there are stests that are still running that have started in the last 24 hours."
  shell: "{{ASB_STESTS_QUERY}}"
  register: RUNNING_STESTS

- name: "Make sure that there are no stests running on this machine"
  assert: { that: RUNNING_STESTS.stdout_lines | length == 0 }

- name: "Uninstall stest RPM if installed"
  yum:
      name: AroraConfig-stest.x86_64
      state: absent

# ----------------------------------------------------------------------------------
- block:
   - fail: msg="No disk drives detected, something is very wrong"
     when: disks is not defined

   - name: "Health check each disk."
     include: "{{STAGES_PATH}}/reimage_conf/smart_check.yml disk={{ item }}"
     with_items: "{{ disks }}"
        
  rescue:
   - name: "There's nothing more that ASB can do. Setting status to 'HELP_ME"
     command: "{{ASB_DB_UPDATE_HELP}}"

   - fail: msg="Machine is too unhealthy to be reimaged - aborting without making changes"
# ----------------------------------------------------------------------------------
#
- name: "Update server status"
  command:  "{{ASB_DB_UPDATE_REIMG_WIPE}}"
...

