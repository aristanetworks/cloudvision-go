---
- name: "Gather info about disks on this machine"
  include: "{{STAGES_PATH}}/reimage_conf/gather_disk_info.yml"

# ----------------------------------------------------------------------------------
- block:
   - name: "Check /proc/mdstat for leftover RAID array."
     shell: "! (grep -qe 'md[1-9][0-9]*' /proc/mdstat)"
     register: SANITY_RAID
     ignore_errors: true

   - fail: msg="RAID arrays were not properly removed."
     when: SANITY_RAID | failed

   - name: "Check that no MD devices still exist."
     shell: "! (ls -l /dev/md* | grep -e '/dev/md[1-9][0-9]*')"
     register: SANITY_MD
     ignore_errors: true

   - fail: msg="Not all MD devices were removed."
     when: SANITY_MD | failed

   - fail: msg="Not all drives were properly wiped."
     when: partitions | length > 0

  rescue:
   - name: "Some error occurred, retrying ASB from beginning."
     include: "{{STAGES_PATH}}/reimage_conf/retry.yml"

   - fail: msg="Automatic reimaging was unsuccessful - retrying"
# ----------------------------------------------------------------------------------

- name: "Update server status"
  command: "{{ASB_DB_UPDATE_CORE}}"
...
