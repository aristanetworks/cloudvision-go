
- name: create folder for etcd2 drop-in file
  become: True
  file:
    path: /etc/systemd/system/etcd2.service.d
    owner: root
    group: root
    mode: 0755
    state: directory

- name: install etcd2 config
  become: True
  copy:
    content: |
      [Service]
      Environment="ETCD_ADVERTISE_CLIENT_URLS=http://{{ inventory_hostname }}:2379"
      Environment="ETCD_CORS=*"
      Environment="ETCD_INITIAL_ADVERTISE_PEER_URLS=http://{{ inventory_hostname }}:2380"
      Environment="ETCD_INITIAL_CLUSTER={% set comma = joiner(",") %}{% for host in groups.etcd2 %}{{ comma() }}etcd{{ loop.index - 1 }}=http://{{ hostvars[host]['inventory_hostname'] }}:2380{% endfor %}"
      Environment="ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379"
      Environment="ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380"
      Environment="ETCD_NAME=etcd{{ groups.etcd2.index(inventory_hostname) }}"
    dest: /etc/systemd/system/etcd2.service.d/20-etcd2.conf
    owner: root
    group: root
    mode: 0644
  register: etcdconfig

- name: Reload systemd config
  become: True
  systemd:
    name: etcd2
    state: restarted
    daemon_reload: yes
  when: etcdconfig.changed

- name: enable etcd2 for etcd nodes
  become: True
  systemd:
    name: etcd2
    enabled: yes
    state: started
