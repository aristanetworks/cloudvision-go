
- name: create etcd2 configuration directories
  become: True
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0755
    state: directory
  with_items:
    - /etc/ssl/etcd
    - /etc/systemd/system/etcd2.service.d

- name: install etcd2 certificates
  become: True
  copy:
    content: "{{ item.value }}"
    dest: /etc/ssl/etcd/{{ item.key }}
    owner: etcd
    group: etcd
    mode: 0644
  with_dict: "{{ certificates }}"
  register: etcd_certs

- name: install etcd2 config
  become: True
  copy:
    content: |
      [Service]
      Environment="ETCD_ADVERTISE_CLIENT_URLS=https://{{ inventory_hostname }}:2379"
      Environment="ETCD_CORS=*"
      Environment="ETCD_INITIAL_ADVERTISE_PEER_URLS=https://{{ inventory_hostname }}:2380"
      Environment="ETCD_INITIAL_CLUSTER={% set comma = joiner(",") %}{% for host in groups.etcd2 %}{{ comma() }}etcd{{ loop.index - 1 }}=https://{{ hostvars[host]['inventory_hostname'] }}:2380{% endfor %}"
      Environment="ETCD_LISTEN_CLIENT_URLS=https://{{ lookup('ip_by_prefix', private_ip_prefix) }}:2379"
      Environment="ETCD_LISTEN_PEER_URLS=https://{{ lookup('ip_by_prefix', private_ip_prefix) }}:2380"
      Environment="ETCD_NAME=etcd{{ groups.etcd2.index(inventory_hostname) }}"
      # client certificates
      Environment="ECTD_CERT_FILE=/etc/ssl/etcd/ca.pem"
      Environment="ETCD_TRUSTED_CA_FILE=/etc/ssl/etcd/ca.pem"
      Environment="ETCD_CERT_FILE=/etc/ssl/etcd/etcd.pem"
      Environment="ETCD_KEY_FILE=/etc/ssl/etcd/etcd-key.pem"
      Environment="ETCD_CLIENT_CERT_AUTH=true"
      # Peer certificates
      Environment="ECTD_PEER_CERT_FILE=/etc/ssl/etcd/ca.pem"
      Environment="ETCD_PEER_TRUSTED_CA_FILE=/etc/ssl/etcd/ca.pem"
      Environment="ETCD_PEER_CERT_FILE=/etc/ssl/etcd/etcd.pem"
      Environment="ETCD_PEER_KEY_FILE=/etc/ssl/etcd/etcd-key.pem"
      Environment="ETCD_PEER_CLIENT_CERT_AUTH=true"

    dest: /etc/systemd/system/etcd2.service.d/20-etcd2.conf
    owner: root
    group: root
    mode: 0644
  register: etcdconfig

- name: Reload systemd config
  become: True
  systemd:
    name: etcd2
    state: restarted
    daemon_reload: yes
  when: etcdconfig.changed or etcd_certs.changed

- name: enable etcd2 for etcd nodes
  become: True
  systemd:
    name: etcd2
    enabled: yes
    state: started

- name: Add vars for etcdctl
  copy:
    content: |
      export ETCDCTL_CA_FILE=/etc/ssl/etcd/ca.pem
      export ETCDCTL_CERT_FILE=/etc/ssl/etcd/etcd.pem
      export ETCDCTL_KEY_FILE=/etc/ssl/etcd/etcd-key.pem
      export ETCDCTL_ENDPOINT={% set comma = joiner(",") %}{% for host in groups.etcd2 %}{{ comma() }}https://{{ hostvars[host]['inventory_hostname'] }}:2379{% endfor %}
    dest: "{{ ansible_env.HOME }}/.bashrc.d/etcd.bashrc"
