
---

- name: create folder dir for openvpn certs
  file:
    path: "{{ inventory_dir }}/files/openvpn"
    state: directory

- name: Create openvpn ca-csr.json file
  copy:
    content: |
      {
        "CN": "OpenVPN CA",
        "key": {
          "algo": "rsa",
          "size": 2048
        },
        "names": [
          {
            "O": "Arista Networks",
            "OU": "Autogenerated openvpn CA",
            "L": "San Francisco",
            "ST": "California",
            "C": "US"
          }
        ]
      }
    dest: "{{ inventory_dir }}/files/openvpn/ca-csr.json"

- name: Create openvpn ca-config.json file
  copy:
    content: |
      {
        "signing": {
          "default": {
            "usages": [
              "signing",
              "key encipherment",
              "server auth",
              "client auth"
            ],
            "expiry": "87600h"
          }
        }
      }
    dest: "{{ inventory_dir }}/files/openvpn/ca-config.json"

- name: Create openvpn req-csr.json file
  template:
    src: openvpn-req-csr.json.j2
    dest: "{{ inventory_dir }}/files/openvpn/req-csr.json"

- name: Create openvpn client-csr.json file
  copy:
    content: |
      {
        "CN": "openvpn-clients",
        "key": {
          "algo": "rsa",
          "size": 2048
        },
        "names": [
          {
            "O": "Arista Networks",
            "OU": "autogenerated openvpn cert",
            "L": "San Francisco",
            "ST": "California",
            "C": "US"
          }
        ]
      }
    dest: "{{ inventory_dir }}/files/openvpn/client-csr.json"

- name: Generate openvpn ca cert
  shell: >
    cfssl gencert
    -initca "{{ inventory_dir }}/files/openvpn/ca-csr.json"
    | cfssljson -bare "{{ inventory_dir }}/files/openvpn/ca"

- name: Generate openvpn server certs
  shell: >
    cfssl gencert
    -ca "{{ inventory_dir }}/files/openvpn/ca.pem"
    -ca-key "{{ inventory_dir }}/files/openvpn/ca-key.pem"
    -config "{{ inventory_dir }}/files/openvpn/ca-config.json" "{{ inventory_dir }}/files/openvpn/req-csr.json"
    -profile server
    | cfssljson -bare "{{ inventory_dir }}/files/openvpn/openvpn"

- name: Generate openvpn client certs
  shell: >
    cfssl gencert
    -ca "{{ inventory_dir }}/files/openvpn/ca.pem"
    -ca-key "{{ inventory_dir }}/files/openvpn/ca-key.pem"
    -config "{{ inventory_dir }}/files/openvpn/ca-config.json"
    -profile client
    "{{ inventory_dir }}/files/openvpn/client-csr.json" | cfssljson -bare "{{ inventory_dir }}/files/openvpn/client"

- name: Generate ta.key
  command: openvpn --genkey --secret "{{ inventory_dir }}/files/openvpn/ta.key"

- name: Generate Diffie hellman parameters
  command: openssl dhparam -out "{{ inventory_dir }}/files/openvpn/dh2048.pem" 2048

- name: Encrypt certificates
  shell: >
    ansible-vault
    --vault-password-file ./.pass.{{ cluster_name }}
    encrypt "{{ inventory_dir }}/files/openvpn/{{ item }}"
  with_items:
    - ca-key.pem
    - ca.csr
    - ca.pem
    - openvpn-key.pem
    - openvpn.csr
    - openvpn.pem
    - client-key.pem
    - client.csr
    - client.pem
    - ta.key
    - dh2048.pem
