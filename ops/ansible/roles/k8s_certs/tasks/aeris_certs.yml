
---

- name: create folder dir for aeris certs
  file:
    path: "{{ inventory_dir }}/files/aeris"
    state: directory

- name: Create aeris ca-csr.json file
  copy:
    content: |
      {
        "CN": "Autogenerated CA",
        "key": {
          "algo": "rsa",
          "size": 2048
        },
        "names": [
          {
            "O": "Arista Networks",
            "OU": "Autogenerated aeris cluster CA",
            "L": "San Francisco",
            "ST": "California",
            "C": "US"
          }
        ]
      }
    dest: "{{ inventory_dir }}/files/aeris/ca-csr.json"

- name: Create aeris ca-config.json file
  copy:
    content: |
      {
        "signing": {
          "default": {
            "usages": [
              "signing",
              "key encipherment",
              "server auth",
              "client auth"
            ],
            "expiry": "87600h"
          }
        }
      }
    dest: "{{ inventory_dir }}/files/aeris/ca-config.json"

- name: Generate aeris ca cert
  shell: >
    cfssl gencert
    -initca "{{ inventory_dir }}/files/aeris/ca-csr.json"
    | cfssljson -bare "{{ inventory_dir }}/files/aeris/ca"

- name: Encrypt certificates
  shell: >
    ansible-vault
    --vault-password-file ./.pass.{{ cluster_name }}
    encrypt "{{ inventory_dir }}/files/aeris/{{ item }}"
  with_items:
    - ca-key.pem
    - ca.csr
    - ca.pem
