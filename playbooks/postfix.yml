---
#
# Our firewall prevents internal machines from directly sending mail
# to hosts on the internet.  Internally machines are still in the
# "aristanetworks.com", but we want it to look like they all come from
# "arista.com".  And some of the mail that is generated by our automation
# is larger than the postfix default.
#
# Modify the default postfix configuration:
# - rewrite the the envelope sender.
# - specify the relay host.
# - specify the max size of messages
# - undo some changes we no longer need.
- hosts: all
  become: yes
  become_user: root
  vars:
     aroraConfigPostfix:       "/var/lib/AroraConfig/postfix"
     postFixEtc:                "/etc/postfix"
     postfixMainCf:             "{{postFixEtc}}/main.cf"
     canonicalFile:          "{{postFixEtc}}/canonical.arista"
     maxMsgSize:                1073741824
  tasks:
     - stat: path="{{aroraConfigPostfix}}"
       register: fixPostfix

     - block:
        - name: "Ensure postfix is installed and is latest."
          yum: name=postfix state=latest
          when: False

        - name: "Postfix canonize regexp."
          lineinfile:
             dest: "{{canonicalFile}}"
             line: "/^(.*@)(.*)aristanetworks.com$/     ${1}arista.com"
             create: yes

        - name: "Outgoing sender should be @arista.com and not @aristanetworks.com"
          lineinfile:
             dest: "{{postfixMainCf}}"
             line: "sendercanonical_maps = regexp:{{canonicalizeFile}}"
          notify: "reload postfix"

        - name: "Specify relay host."
          lineinfile:
             dest: "{{postfixMainCf}}"
             regexp: "relayhost = aristanetworks.com"
             line: "relayhost = aristanetworks.com"
          notify: "reload postfix"

        - name: "Default mailbox size is to small to handle reviewboard messages."
          lineinfile:
             dest: "{{postfixMainCf}}"
             regexp: "mailbox_size_limit = \\d*"
             line: "mailbox_size_limit = {{maxMsgSize}}"
          notify: "reload postfix"

        - name: "Default message size is to small to handle reviewboard messages."
          lineinfile:
             dest: "{{postfixMainCf}}"
             regexp: "message_size_limit = \\d*"
             line: "message_size_limit = {{maxMsgSize}}"
          notify: "reload postfix"

        #----------------------------------------------------------------------
        # Start: Temp action to remove prior changes we do not need.
        #----------------------------------------------------------------------
        - name: "Undo adding mydomain"
          replace:
             dest: "{{postfixMainCf}}"
             regexp: "^[ \t]*(mydomain = .*$)"
             replace: "#\\1"
          notify: "reload postfix"

        - name: "Undo adding myorigin"
          replace:
             dest: "{{postfixMainCf}}"
             regexp: "^[ \t]*(myorigin = .*$)"
             replace: "#\\1"
          notify: "reload postfix"

        - name: "Undo adding fallback_transport"
          replace:
             dest: "{{postfixMainCf}}"
             regexp: "^[ \t]*(fallback_transport = .*)$"
             replace: "#\\1"
          notify: "reload postfix"
        #----------------------------------------------------------------------
        # End: Temp action to remove prior changes we do not need.
        #----------------------------------------------------------------------
       when: fixPostfix.stat.exists == True

  handlers:
     - name: "reload postfix"
       command: postfix reload
     - name: "postmap canonical"
       command: postmap /etc/postfix/canonical
...
