---
#
# Our firewall prevents internal machines from directly sending mail
# to hosts on the internet.  Internally machines are still in the
# "aristanetworks.com", but we want it to look like they all come from
# "arista.com".  And some of the mail that is generated by our automation
# is larger than the postfix default.
#
# Modify the default postfix configuration:
# - rewrite the the envelope sender.
# - specify the relay host.
# - specify the max size of messages
# - undo some changes we no longer need.

- name: "postfix"
  hosts: all
  become: yes
  become_user: root
  vars:
     postfix_aroraConfigPostfix: "/var/lib/AroraConfig/postfix"
     postfix_etc:                "/etc/postfix"
     postfix_mainCf:             "{{postfix_etc}}/main.cf"
     postfix_canonicalFile:      "{{postfix_etc}}/canonical.arista"
     postfix_maxMsgSize:         1073741824
  tasks:
     - stat: path="{{postfix_aroraConfigPostfix}}"
       register: fixPostfix

     - block:
        - name: "Ensure postfix is installed and is latest."
          yum: name=postfix state=latest
          when: TEST is not defined
      
        # https://github.com/docker/docker/issues/10180
        - name: "Ensure postfix is installed, rebuild cached MariaDB - TEST ENV ONLY"
          shell: rpm --rebuilddb && yum -y install postfix
          when: TEST is defined

        # https://forums.opensuse.org/showthread.php/436441-Postfix-error-message
        - name: "Remove IPv6 settings for postfix because our docker containers don't support IPv6 routing yet -- TEST ENV ONLY"
          lineinfile:
             dest: "{{postfix_mainCf}}"
             regexp: "inet_protocols = all"
             line: "inet_protocols = ipv4"
          notify: "reload postfix"
          when: TEST is defined

        - name: "Start postfix, in case it is reinstalled."
          command: postfix start
          # We ignore errors from this step if postfix is already running. If postfix
          # is already running then changes below will force reload, which is fine.
          ignore_errors: yes

        - name: "Postfix canonize regexp."
          lineinfile:
             dest: "{{postfix_canonicalFile}}"
             line: "/^(.*@)(.*)aristanetworks.com$/     ${1}arista.com"
             create: yes

        - name: "Outgoing sender should be @arista.com and not @aristanetworks.com"
          lineinfile:
             dest: "{{postfix_mainCf}}"
             line: "sender_canonical_maps = regexp:{{postfix_canonicalFile}}"
          notify: "reload postfix"

        - name: "Specify relay host."
          lineinfile:
             dest: "{{postfix_mainCf}}"
             regexp: "relayhost = aristanetworks.com"
             line: "relayhost = aristanetworks.com"
          notify: "reload postfix"

        - name: "Default mailbox size is too small to handle reviewboard messages."
          lineinfile:
             dest: "{{postfix_mainCf}}"
             regexp: "mailbox_size_limit = \\d*"
             line: "mailbox_size_limit = {{postfix_maxMsgSize}}"
          notify: "reload postfix"

        - name: "Default message size is too small to handle reviewboard messages."
          lineinfile:
             dest: "{{postfix_mainCf}}"
             regexp: "message_size_limit = \\d*"
             line: "message_size_limit = {{postfix_maxMsgSize}}"
          notify: "reload postfix"

        #----------------------------------------------------------------------
        # Start: Temp action to remove prior changes we do not need.
        #----------------------------------------------------------------------
        - name: "Undo adding mydomain"
          replace:
             dest: "{{postfix_mainCf}}"
             regexp: "^[ \t]*(mydomain = .*$)"
             replace: "#\\1"
          notify: "reload postfix"

        - name: "Undo adding myorigin"
          replace:
             dest: "{{postfix_mainCf}}"
             regexp: "^[ \t]*(myorigin = .*$)"
             replace: "#\\1"
          notify: "reload postfix"

        - name: "Undo adding fallback_transport"
          replace:
             dest: "{{postfix_mainCf}}"
             regexp: "^[ \t]*(fallback_transport = .*)$"
             replace: "#\\1"
          notify: "reload postfix"
        #----------------------------------------------------------------------
        # End: Temp action to remove prior changes we do not need.
        #----------------------------------------------------------------------

        - name: "TEST"
          script: test/test_postfix.py
          when: TEST is defined

       when: fixPostfix.stat.exists == True 
         
     
  handlers:
     - name: "reload postfix"
       command: postfix reload
     - name: "postmap canonical"
       command: postmap {{postfix_canonicalFile}}
...
